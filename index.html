<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Portal 8-B</title>
    <link rel="icon" href="favicon.jpg" type="image/jpeg">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;700&family=Space+Grotesk:wght@300;500;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        theme: { DEFAULT: 'var(--primary)', dim: 'var(--primary-dim)', glow: 'var(--primary-glow)' }
                    },
                    fontFamily: { sans: ['Outfit', 'sans-serif'], display: ['Space Grotesk', 'sans-serif'] }
                }
            }
        }
    </script>

    <style>

        :root {
            --primary: #ff0000; --primary-dim: #990000; --primary-glow: rgba(255, 0, 0, 0.5);
            --bg-grad: radial-gradient(circle at 10% 20%, rgba(255, 0, 0, 0.15) 0%, transparent 40%), radial-gradient(circle at 90% 80%, rgba(200, 0, 0, 0.10) 0%, transparent 40%);
        }
        [data-theme="purple"] { --primary: #a855f7; --primary-dim: #6b21a8; --primary-glow: rgba(168, 85, 247, 0.5); --bg-grad: radial-gradient(circle at 10% 20%, rgba(168, 85, 247, 0.15) 0%, transparent 40%), radial-gradient(circle at 90% 80%, rgba(59, 130, 246, 0.15) 0%, transparent 40%); }
        [data-theme="green"] { --primary: #00ff41; --primary-dim: #006400; --primary-glow: rgba(0, 255, 65, 0.5); --bg-grad: radial-gradient(circle at 50% 50%, rgba(0, 255, 65, 0.05) 0%, transparent 60%), repeating-linear-gradient(0deg, transparent, transparent 2px, #003300 3px); }
        [data-theme="dark"] { --primary: #d1d5db; --primary-dim: #4b5563; --primary-glow: rgba(255, 255, 255, 0.1); --bg-grad: none; }

        body { background-color: #050505; background-image: var(--bg-grad); color: #f3f4f6; min-height: 100vh; overflow-x: hidden; transition: background-image 0.5s ease; }
        .glass-panel { background: rgba(10, 10, 10, 0.85); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5); transition: all 0.3s ease; }
        .glass-panel:hover { border-color: var(--primary); box-shadow: 0 0 20px var(--primary-glow); }
        .input-glass { background: rgba(20, 20, 20, 0.6); border: 1px solid rgba(255, 255, 255, 0.1); color: white; transition: all 0.3s; }
        .input-glass:focus { border-color: var(--primary); box-shadow: 0 0 15px var(--primary-glow); outline: none; }
        .btn-theme { background: linear-gradient(90deg, var(--primary-dim), var(--primary)); color: white; transition: all 0.3s ease-in-out; border: 1px solid transparent; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; }
        [data-theme="dark"] .btn-theme { color: black; font-weight: 800; background: #e5e5e5; } 
        .btn-theme:hover { filter: brightness(1.2); box-shadow: 0 0 25px var(--primary-glow); transform: scale(1.02); }
        .text-theme-dynamic { color: var(--primary); text-shadow: 0 0 10px var(--primary-glow); }
        .border-theme-dynamic { border-color: var(--primary); }
        .bg-theme-dynamic { background-color: var(--primary); }
        .slide-in-top { animation: slide-in-top 1.0s cubic-bezier(0.250, 0.460, 0.450, 0.940) both; }
        @keyframes slide-in-top { 0% { transform: translateY(-50px); opacity: 0; filter: blur(5px); } 100% { transform: translateY(0); opacity: 1; filter: blur(0); } }
        .fade-in-slow { animation: fadeIn 1.5s ease-in forwards; opacity: 0; animation-delay: 0.3s; }
        @keyframes fadeIn { to { opacity: 1; } }
        .pop-in { animation: popIn 0.5s forwards; opacity: 0; transform: scale(0.8); }
        @keyframes popIn { to { opacity: 1; transform: scale(1); } }
        .app-enter { animation: appEnter 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; opacity: 0; transform: translateY(30px); }
        @keyframes appEnter { from { opacity: 0; transform: translateY(30px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }
        .calendar-day { min-height: 40px; border-radius: 6px; background: rgba(255,255,255,0.03); display: flex; align-items: center; justify-content: center; font-size: 0.8rem; position: relative; }
        .current-day { border: 1px solid rgba(255,255,255,0.6); color: #fff; font-weight: bold; background: rgba(255, 255, 255, 0.1); box-shadow: 0 0 10px rgba(255,255,255,0.1); }
        .has-event::after { content: ''; position: absolute; bottom: 4px; width: 4px; height: 4px; border-radius: 50%; }
        .evt-prova::after { background: #ef4444; box-shadow: 0 0 5px #ef4444; }
        .evt-trabalho::after { background: #3b82f6; box-shadow: 0 0 5px #3b82f6; }
        .evt-simulado::after { background: #eab308; box-shadow: 0 0 5px #eab308; }
        .xp-bar-fill { background: linear-gradient(90deg, var(--primary), var(--primary-dim)); box-shadow: 0 0 10px var(--primary-glow); transition: width 1s ease; }
        .poll-bar-container { position: relative; width: 100%; height: 40px; background: rgba(255,255,255,0.05); border-radius: 8px; overflow: hidden; margin-bottom: 8px; }
        .poll-bar-fill { height: 100%; background: linear-gradient(90deg, var(--primary-dim), var(--primary)); transition: width 1s ease-out; opacity: 0.7; }
        .poll-bar-text { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: space-between; padding: 0 16px; font-size: 0.8rem; font-weight: bold; color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.8); }
        .poll-bar-fill.winner { background: linear-gradient(90deg, #10b981, #34d399); opacity: 1; box-shadow: 0 0 15px rgba(16, 185, 129, 0.4); }
        .theme-switcher { position: fixed; top: 20px; right: 20px; z-index: 100; display: flex; flex-direction: column; align-items: end; gap: 10px; }
        .theme-btn-main { width: 50px; height: 50px; border-radius: 50%; background: rgba(30,30,30,0.9); border: 1px solid rgba(255,255,255,0.2); color: white; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        .theme-btn-main:hover { transform: rotate(90deg); border-color: var(--primary); color: var(--primary); }
        .theme-options { background: rgba(0,0,0,0.9); padding: 10px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); display: flex; flex-direction: column; gap: 8px; transform: scale(0); transform-origin: top right; transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .theme-options.open { transform: scale(1); }
        .color-opt { width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: transform 0.2s; }
        .color-opt:hover { transform: scale(1.2); }
        .color-opt.active { border-color: white; box-shadow: 0 0 10px white; }
        .list-item { transition: all 0.2s; border-left: 2px solid transparent; }
        .list-item:hover { background: rgba(255, 255, 255, 0.05); padding-left: 1rem; border-left-color: var(--primary); }
        .hidden { display: none !important; }
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: var(--primary); }

        /* Notification Badge */
        .badge-dot { position: absolute; top: 0; right: 0; width: 10px; height: 10px; background-color: #ef4444; border-radius: 50%; border: 2px solid #000; display: none; }
        .badge-dot.active { display: block; animation: pulse 2s infinite; }
        .notification-item { border-left: 3px solid transparent; transition: all 0.2s; }
        .notification-item.unread { border-left-color: var(--primary); background: rgba(255,255,255,0.03); }
        
        /* Checkbox Customizado */
        input[type="checkbox"] { accent-color: var(--primary); }
    </style>
</head>
<body class="overflow-x-hidden">

    <div class="theme-switcher">
        <button onclick="toggleThemeMenu()" class="theme-btn-main"><i class="fas fa-palette text-xl"></i></button>
        <div id="theme-menu" class="theme-options">
            <div onclick="setTheme('red')" class="color-opt bg-red-600" title="Infernal"></div>
            <div onclick="setTheme('purple')" class="color-opt bg-purple-600" title="Cyber"></div>
            <div onclick="setTheme('green')" class="color-opt bg-green-500" title="Hacker"></div>
            <div onclick="setTheme('dark')" class="color-opt bg-gray-500 border border-white/20" title="Blackout"></div>
        </div>
    </div>

    <div id="auth-screen" class="flex items-center justify-center min-h-screen p-4 relative z-50">
        <div class="glass-panel w-full max-w-md p-8 rounded-2xl border-t border-theme-dynamic relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-theme to-transparent opacity-100"></div>
            <div class="text-center mb-8">
                <img src="favicon.jpg" class="w-20 h-20 mx-auto mb-4 rounded-xl shadow-[0_0_30px_rgba(255,255,255,0.1)] slide-in-top" style="border: 1px solid var(--primary);" onerror="this.style.display='none'">
                <h1 class="font-display text-5xl font-bold mb-2 tracking-tighter text-white slide-in-top" style="text-shadow: 0 0 30px var(--primary-glow);">PORTAL 8-B</h1>
                <p class="text-theme-dynamic font-bold tracking-widest text-xs uppercase fade-in-slow">Sistema Oficial</p>
            </div>
            
            <form id="login-form" class="space-y-4 fade-in-slow">
                <div id="register-fields" class="hidden space-y-4">
                    <div><label class="text-xs font-bold text-gray-400 uppercase ml-1">Nome / Apelido</label><input type="text" id="reg-name" class="input-glass w-full px-4 py-3 rounded-xl mt-1" placeholder="Ex: Guilherme"></div>
                    <div><label class="text-xs font-bold text-gray-400 uppercase ml-1">Telefone</label><input type="tel" id="reg-phone" class="input-glass w-full px-4 py-3 rounded-xl mt-1" placeholder="(XX) 9XXXX-XXXX"></div>
                    
                    <div class="flex items-center gap-3 bg-black/20 p-2 rounded-lg border border-white/5">
                        <input type="checkbox" id="terms-check" class="w-5 h-5 rounded cursor-pointer">
                        <label for="terms-check" class="text-xs text-slate-400 cursor-pointer select-none">
                            Li e aceito os <a href="Termos_e_condições.pdf" target="_blank" class="text-theme-dynamic font-bold hover:underline">Termos e Condições</a>
                        </label>
                    </div>
                </div>
                
                <div><label class="text-xs font-bold text-gray-400 uppercase ml-1">E-mail</label><input type="email" id="email" class="input-glass w-full px-4 py-3 rounded-xl mt-1" required></div>
                <div><label class="text-xs font-bold text-gray-400 uppercase ml-1">Senha</label><input type="password" id="password" class="input-glass w-full px-4 py-3 rounded-xl mt-1" required></div>
                <button type="submit" id="btn-login" class="btn-theme w-full py-4 rounded-xl shadow-lg mt-4 cursor-pointer">ACESSAR SISTEMA</button>
            </form>
            
            <div class="mt-6 text-center fade-in-slow"><button id="btn-toggle-register" class="text-slate-500 text-sm hover:text-white transition-colors">Não tem conta? <span class="text-theme-dynamic font-bold">Criar cadastro</span></button></div>
            <p id="auth-error" class="text-red-400 text-center text-sm mt-4 hidden"></p>
        </div>
    </div>

    <div id="app-screen" class="min-h-screen hidden flex flex-col md:flex-row">
        <nav class="glass-panel w-full md:w-20 md:h-screen fixed bottom-0 md:left-0 z-40 flex md:flex-col justify-between items-center p-4 border-r border-white/5">
            <div class="hidden md:block font-bold text-theme-dynamic text-xl tracking-tighter" style="text-shadow: 0 0 10px var(--primary-glow);">8B</div>
            <div class="flex md:flex-col gap-6 w-full justify-around md:justify-center items-center">
                <button class="nav-btn active text-theme-dynamic text-xl hover:text-white transition hover:scale-110" data-target="dashboard"><i class="fas fa-th-large"></i></button>
                <button class="nav-btn text-slate-500 text-xl hover:text-white transition hover:scale-110" data-target="chat"><i class="fas fa-comments"></i></button>
                <button class="nav-btn text-slate-500 text-xl hover:text-white transition hover:scale-110" data-target="gallery"><i class="fas fa-images"></i></button>
                <button id="btn-logout-sidebar" class="text-red-700 hover:text-red-500 text-xl transition hover:rotate-90"><i class="fas fa-power-off"></i></button>
            </div>
            <div class="hidden md:block h-6"></div>
        </nav>

        <main class="flex-1 md:ml-20 p-4 md:p-6 max-w-7xl mx-auto w-full pb-20 md:pb-6">
            <header class="flex justify-between items-center mb-6 glass-panel p-4 rounded-xl">
                <div><h2 class="text-lg md:text-xl font-display font-bold">Olá, <span id="user-name" class="text-theme-dynamic">Aluno</span></h2></div>
                <div class="flex items-center gap-4">
                    <button onclick="openNotifications()" class="relative text-white hover:text-theme-dynamic transition text-xl">
                        <i class="fas fa-bell"></i>
                        <span id="notif-dot" class="badge-dot"></span>
                    </button>
                    
                    <button id="admin-broadcast-btn" onclick="openBroadcastModal()" class="hidden text-yellow-400 hover:text-yellow-300 transition text-xl" title="Mensagem Geral">
                        <i class="fas fa-bullhorn"></i>
                    </button>

                    <button id="admin-users-btn" onclick="openUsersList()" class="hidden text-blue-400 hover:text-blue-300 transition text-xl" title="Mensagem Privada">
                        <i class="fas fa-users"></i>
                    </button>

                    <button id="mobile-logout-top" class="md:hidden text-red-500 text-xs font-bold border border-red-500/30 px-2 py-1 rounded hover:bg-red-500/10">SAIR</button>
                    <div class="text-right text-xs"><p class="font-bold text-white">NÍVEL <span id="lvl-display" class="text-theme-dynamic text-lg">1</span></p><p class="text-slate-400"><span id="xp-display">0</span> XP</p></div>
                    <div class="w-24 h-2 bg-slate-800 rounded-full overflow-hidden border border-white/5"><div id="xp-bar" class="xp-bar-fill h-full w-0"></div></div>
                </div>
            </header>

            <section id="section-dashboard" class="page-section space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="md:col-span-2 glass-panel p-6 rounded-2xl relative overflow-hidden group flex flex-col border-t-2 border-theme-dynamic">
                        <div class="absolute -right-20 -top-20 w-60 h-60 bg-theme-dim rounded-full blur-[100px] opacity-20"></div>
                        <div class="flex justify-between items-center mb-4 z-10">
                            <h3 class="text-2xl font-display font-bold tracking-tight text-white">MURAL <span class="text-theme-dynamic">8-B</span></h3>
                            <div id="admin-news-btn"></div>
                        </div>
                        <div id="news-feed" class="space-y-4 overflow-y-auto max-h-40 z-10 custom-scroll"><p class="text-slate-500">Carregando avisos...</p></div>
                    </div>

                    <div class="glass-panel p-4 rounded-2xl row-span-2 flex flex-col relative overflow-hidden">
                        <div class="absolute -left-10 -bottom-10 w-40 h-40 bg-theme-dim rounded-full blur-[60px] opacity-20"></div>
                        <div class="flex justify-between items-center mb-4 z-10">
                            <h3 class="font-bold text-theme-dynamic"><i class="fas fa-poll mr-2"></i>Votação</h3>
                            <div id="admin-poll-btn"></div>
                        </div>
                        <div id="poll-container" class="flex-1 flex flex-col justify-center z-10 space-y-3"><p class="text-slate-500 text-xs">Nenhuma enquete ativa.</p></div>
                    </div>

                    <div class="glass-panel p-4 rounded-2xl">
                        <div class="flex justify-between items-center mb-2"><h3 class="font-bold text-white"><i class="fas fa-calendar-alt mr-2 text-theme-dynamic"></i>Agenda</h3><span id="mini-month" class="text-xs font-bold uppercase text-theme-dynamic">MÊS</span></div>
                        <div id="mini-calendar-grid" class="grid grid-cols-7 gap-1 text-center mb-3"></div>
                        <div class="grid grid-cols-3 gap-2 text-[9px] text-slate-400 border-t border-white/10 pt-2">
                            <div class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-blue-500 shadow-[0_0_5px_#3b82f6]"></span> Trabalho</div>
                            <div class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-red-600 shadow-[0_0_5px_red]"></span> Prova</div>
                            <div class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-yellow-500 shadow-[0_0_5px_#eab308]"></span> Simulado</div>
                        </div>
                    </div>

                    <div class="glass-panel p-4 rounded-2xl md:col-span-2">
                        <div class="flex justify-between items-center mb-4"><h3 class="font-bold text-white"><i class="fas fa-download mr-2 text-theme-dynamic"></i>Materiais</h3><p id="upload-material-status" class="text-xs text-green-400 hidden animate-pulse">Enviando...</p></div>
                        <div id="downloads-container" class="space-y-2 max-h-40 overflow-y-auto custom-scroll"><div id="downloads-list" class="space-y-2"></div></div>
                    </div>
                    
                    <div class="glass-panel p-4 rounded-2xl flex flex-col border-b-2 border-theme-dynamic">
                        <h3 class="font-bold text-white mb-4"><i class="fas fa-trophy mr-2 text-yellow-500"></i>Ranking XP</h3>
                        <div id="ranking-list" class="space-y-3 flex-1 overflow-y-auto custom-scroll" style="max-height: 200px;"><p class="text-slate-500 text-sm">Carregando...</p></div>
                    </div>
                </div>
            </section>

            <section id="section-chat" class="page-section hidden h-[75vh] flex flex-col">
                <div class="glass-panel flex-1 rounded-2xl flex flex-col overflow-hidden">
                    <div class="p-3 border-b border-white/10 bg-black/40 flex justify-between"><span class="font-bold text-sm text-theme-dynamic">#chat-geral</span><span class="text-xs text-green-400 flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-green-400 shadow-[0_0_5px_#4ade80]"></span> Online</span></div>
                    <div id="chat-box" class="flex-1 overflow-y-auto p-4 space-y-3 custom-scroll"></div>
                    <form id="chat-form" class="p-3 bg-black/30 border-t border-white/10 flex gap-2"><input type="text" id="chat-msg" class="input-glass flex-1 px-4 py-2 rounded-lg text-sm" placeholder="Mensagem..." autocomplete="off"><button type="submit" class="bg-theme-dynamic hover:brightness-125 text-white px-4 py-2 rounded-lg shadow-[0_0_10px_var(--primary-glow)]"><i class="fas fa-paper-plane"></i></button></form>
                </div>
            </section>

            <section id="section-gallery" class="page-section hidden space-y-4">
                <div class="flex justify-between items-center"><h3 class="text-2xl font-bold font-display text-white">Galeria <span class="text-theme-dynamic">8-B</span></h3><p id="upload-status" class="text-xs text-green-400 hidden animate-pulse">Enviando foto...</p></div>
                <div id="gallery-grid" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
            </section>

            <footer class="mt-8 mb-4 text-center">
                <a href="https://wa.me/5516992719558" target="_blank" class="inline-flex items-center gap-2 px-4 py-2 rounded-full glass-panel text-xs text-slate-500 hover:text-white hover:border-theme-dynamic hover:bg-white/5 transition-all"><i class="fab fa-whatsapp text-lg"></i> Falar com o Desenvolvedor</a>
            </footer>
        </main>
    </div>

    <div id="modal-notifications" class="fixed inset-0 bg-black/80 z-[60] hidden flex items-center justify-center p-4">
        <div class="glass-panel w-full max-w-md rounded-2xl flex flex-col max-h-[80vh]">
            <div class="p-4 border-b border-white/10 flex justify-between items-center">
                <h3 class="font-bold text-lg text-white"><i class="fas fa-bell mr-2 text-theme-dynamic"></i> Notificações</h3>
                <button onclick="document.getElementById('modal-notifications').classList.add('hidden')" class="text-slate-400 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <div id="notif-list" class="flex-1 overflow-y-auto p-4 space-y-3 custom-scroll"></div>
        </div>
    </div>

    <div id="modal-broadcast" class="fixed inset-0 bg-black/80 z-[70] hidden flex items-center justify-center p-4">
        <div class="glass-panel w-full max-w-md p-6 rounded-2xl border border-yellow-500/30">
            <h3 class="text-xl font-bold text-yellow-400 mb-4"><i class="fas fa-bullhorn mr-2"></i>Enviar Comunicado Geral</h3>
            <div class="space-y-4">
                <div><label class="text-xs font-bold text-slate-400">Título</label><input type="text" id="bc-title" class="input-glass w-full px-3 py-2 rounded mt-1" placeholder="Ex: Aviso Importante!"></div>
                <div><label class="text-xs font-bold text-slate-400">Mensagem</label><textarea id="bc-content" class="input-glass w-full px-3 py-2 rounded mt-1 h-32 resize-none" placeholder="Digite a mensagem para todos..."></textarea></div>
                <button onclick="sendBroadcast()" class="w-full bg-yellow-600 hover:bg-yellow-500 text-black font-bold py-3 rounded-lg transition">ENVIAR PARA TODOS</button>
                <button onclick="document.getElementById('modal-broadcast').classList.add('hidden')" class="w-full text-slate-500 text-xs hover:text-white mt-2">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="modal-users" class="fixed inset-0 bg-black/80 z-[70] hidden flex items-center justify-center p-4">
        <div class="glass-panel w-full max-w-md rounded-2xl flex flex-col max-h-[80vh]">
            <div class="p-4 border-b border-white/10 flex justify-between items-center">
                <h3 class="font-bold text-lg text-blue-400"><i class="fas fa-users mr-2"></i> Lista de Alunos</h3>
                <button onclick="document.getElementById('modal-users').classList.add('hidden')" class="text-slate-400 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <div id="users-list-container" class="flex-1 overflow-y-auto p-2 space-y-2 custom-scroll">
                <p class="text-center text-slate-500 text-sm mt-4">Carregando...</p>
            </div>
        </div>
    </div>

    <div id="modal-dm" class="fixed inset-0 bg-black/90 z-[80] hidden flex items-center justify-center p-4">
        <div class="glass-panel w-full max-w-sm p-6 rounded-2xl border border-blue-500/30">
            <h3 class="text-lg font-bold text-blue-400 mb-2">Mensagem para: <span id="dm-target-name" class="text-white"></span></h3>
            <input type="hidden" id="dm-target-id">
            <div class="space-y-3">
                <input type="text" id="dm-title" class="input-glass w-full px-3 py-2 rounded" placeholder="Assunto (Ex: Documento pendente)">
                <textarea id="dm-content" class="input-glass w-full px-3 py-2 rounded h-24 resize-none" placeholder="Escreva sua mensagem..."></textarea>
                <button onclick="sendDirectMessage()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-lg transition">ENVIAR</button>
                <button onclick="document.getElementById('modal-dm').classList.add('hidden')" class="w-full text-slate-500 text-xs hover:text-white mt-1">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        function toggleThemeMenu() { document.getElementById('theme-menu').classList.toggle('open'); }
        function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme); localStorage.setItem('portal8b_theme', theme);
            document.getElementById('theme-menu').classList.remove('open');
            document.querySelectorAll('.color-opt').forEach(el => el.classList.remove('active'));
            document.querySelector(`.color-opt[onclick="setTheme('${theme}')"]`).classList.add('active');
        }
        setTheme(localStorage.getItem('portal8b_theme') || 'red');

        const SUPABASE_URL = 'https://gysljyxzlbwdkapjbrcu.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_4wYz4Ziwq-p2Izh2jX-ZJA_9xQJR0cS'; 
        const client = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        let currentUser = null, currentProfile = null;

        const loginForm = document.getElementById('login-form'), authScreen = document.getElementById('auth-screen'), appScreen = document.getElementById('app-screen'), registerFields = document.getElementById('register-fields');
        let isRegistering = false;

        document.getElementById('btn-toggle-register').addEventListener('click', () => {
            isRegistering = !isRegistering;
            document.querySelector('h1').textContent = isRegistering ? "CADASTRO" : "PORTAL 8-B";
            document.getElementById('btn-login').textContent = isRegistering ? "CRIAR CONTA" : "ACESSAR SISTEMA";
            document.getElementById('btn-toggle-register').innerHTML = isRegistering ? 'Voltar para <span class="text-theme-dynamic font-bold">Login</span>' : 'Não tem conta? <span class="text-theme-dynamic font-bold">Criar cadastro</span>';
            if (isRegistering) registerFields.classList.remove('hidden'); else registerFields.classList.add('hidden');
        });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            if(isRegistering && !document.getElementById('terms-check').checked) {
                alert("Você precisa ler e aceitar os Termos e Condições para criar a conta.");
                return;
            }

            const email = document.getElementById('email').value, password = document.getElementById('password').value, btn = document.getElementById('btn-login');
            btn.textContent = "Carregando..."; btn.disabled = true;
            try {
                if (isRegistering) {
                    const name = document.getElementById('reg-name').value, phone = document.getElementById('reg-phone').value;
                    if (!name) throw new Error("Por favor, digite seu nome.");
                    const { error } = await client.auth.signUp({ email, password, options: { data: { nickname: name, phone: phone, avatar_text: name.substring(0,2).toUpperCase() } } });
                    if (error) throw error; alert("Conta criada! Verifique seu e-mail."); window.location.reload(); 
                } else {
                    const { data, error } = await client.auth.signInWithPassword({ email, password });
                    if (error) throw error; currentUser = data.user; await enterApp();
                }
            } catch (error) { alert("Erro: " + error.message); } finally { btn.textContent = isRegistering ? "CRIAR CONTA" : "ACESSAR SISTEMA"; btn.disabled = false; }
        });

        async function enterApp() {
            authScreen.classList.add('hidden'); appScreen.classList.remove('hidden'); appScreen.classList.add('flex', 'app-enter');
            const { data: profile } = await client.from('profiles').select('*').eq('id', currentUser.id).single();
            if(profile) {
                currentProfile = profile; 
                document.getElementById('user-name').textContent = profile.nickname || profile.email.split('@')[0];
                document.getElementById('xp-display').textContent = profile.xp; document.getElementById('lvl-display').textContent = profile.level;
                document.getElementById('xp-bar').style.width = `${(profile.xp % 100)}%`;
                
                if(profile.is_admin) {
                    document.getElementById('admin-broadcast-btn').classList.remove('hidden');
                    document.getElementById('admin-users-btn').classList.remove('hidden');
                }
            } else { document.getElementById('user-name').textContent = currentUser.email.split('@')[0]; }
            setupChat(); loadDashboardData(); checkNotifications();
        }

        async function loadDashboardData() { renderMiniCalendar(); loadDownloads(); loadRanking(); loadGallery(); loadNews(); loadPoll(); }
        async function gainXP(amount) { try { await client.rpc('add_xp', { amount: amount }); } catch(e) {} }
        function sanitizeFileName(name) { return name.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, '_'); }

        async function checkNotifications() {
            const { data } = await client.from('notifications').select('*').eq('user_id', currentUser.id).order('created_at', {ascending: false});
            const unreadCount = data ? data.filter(n => !n.is_read).length : 0;
            if(unreadCount > 0) document.getElementById('notif-dot').classList.add('active'); else document.getElementById('notif-dot').classList.remove('active');
        }
        async function openNotifications() {
            document.getElementById('modal-notifications').classList.remove('hidden'); const list = document.getElementById('notif-list');
            list.innerHTML = '<p class="text-slate-500 text-center text-sm py-4">Carregando...</p>';
            const { data } = await client.from('notifications').select('*').eq('user_id', currentUser.id).order('created_at', {ascending: false});
            list.innerHTML = ''; if(!data || data.length === 0) { list.innerHTML = '<p class="text-slate-500 text-center text-sm py-4">Nenhuma notificação.</p>'; return; }
            const unreadIds = data.filter(n => !n.is_read).map(n => n.id);
            if(unreadIds.length > 0) { await client.from('notifications').update({is_read: true}).in('id', unreadIds); document.getElementById('notif-dot').classList.remove('active'); }
            data.forEach(n => {
                const date = new Date(n.created_at).toLocaleDateString('pt-BR');
                list.innerHTML += `<div class="notification-item p-3 bg-black/40 rounded-lg mb-2 ${!n.is_read ? 'unread' : ''}"><div class="flex justify-between items-start"><h4 class="font-bold text-white text-sm">${n.title}</h4><span class="text-[10px] text-slate-500">${date}</span></div><p class="text-xs text-slate-300 mt-1">${n.content}</p></div>`;
            });
        }
        function openBroadcastModal() { document.getElementById('modal-broadcast').classList.remove('hidden'); }
        async function sendBroadcast() {
            if(!currentProfile.is_admin) return;
            const title = document.getElementById('bc-title').value, content = document.getElementById('bc-content').value;
            if(!title || !content) return alert("Preencha tudo!");
            const btn = event.target; btn.textContent = "ENVIANDO..."; btn.disabled = true;
            try {
                const { data: profiles } = await client.from('profiles').select('id');
                const messages = profiles.map(p => ({ user_id: p.id, title: title, content: content }));
                const { error } = await client.from('notifications').insert(messages);
                if(error) throw error; alert("Enviado para todos!");
                document.getElementById('modal-broadcast').classList.add('hidden');
                document.getElementById('bc-title').value = ""; document.getElementById('bc-content').value = "";
            } catch(e) { alert("Erro: " + e.message); } finally { btn.textContent = "ENVIAR PARA TODOS"; btn.disabled = false; }
        }
        async function openUsersList() {
            if(!currentProfile.is_admin) return; document.getElementById('modal-users').classList.remove('hidden');
            const container = document.getElementById('users-list-container');
            const { data: users } = await client.from('profiles').select('*').order('nickname', {ascending: true});
            container.innerHTML = ''; if(!users) { container.innerHTML = 'Erro ao carregar.'; return; }
            users.forEach(user => {
                const name = user.nickname || user.email;
                container.innerHTML += `<div class="flex items-center justify-between bg-white/5 p-3 rounded-lg border border-white/5 hover:border-blue-500/50 transition"><div class="flex items-center gap-3"><div class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center font-bold text-xs">${user.avatar_text || '?'}</div><div><p class="font-bold text-sm text-white">${name}</p><p class="text-[10px] text-slate-500">Nível ${user.level}</p></div></div><button onclick="openDirectMsg('${user.id}', '${name}')" class="bg-blue-600 hover:bg-blue-500 text-white w-8 h-8 rounded flex items-center justify-center shadow-lg transition"><i class="fas fa-envelope"></i></button></div>`;
            });
        }
        function openDirectMsg(userId, userName) { document.getElementById('modal-dm').classList.remove('hidden'); document.getElementById('dm-target-id').value = userId; document.getElementById('dm-target-name').innerText = userName; }
        async function sendDirectMessage() {
            const userId = document.getElementById('dm-target-id').value, title = document.getElementById('dm-title').value, content = document.getElementById('dm-content').value;
            if(!title || !content) return alert("Escreva algo!");
            const btn = event.target; btn.innerText = "ENVIANDO..."; btn.disabled = true;
            try {
                const { error } = await client.from('notifications').insert({ user_id: userId, title: `Mensagem Privada: ${title}`, content: content });
                if(error) throw error; alert("Enviada!"); document.getElementById('modal-dm').classList.add('hidden');
                document.getElementById('dm-title').value = ""; document.getElementById('dm-content').value = "";
            } catch(e) { alert("Erro: " + e.message); } finally { btn.innerText = "ENVIAR"; btn.disabled = false; }
        }

        async function loadPoll() {
            const container = document.getElementById('poll-container'), adminBtn = document.getElementById('admin-poll-btn');
            if(currentProfile && currentProfile.is_admin) adminBtn.innerHTML = `<button onclick="createPoll()" class="text-[10px] bg-theme-dynamic hover:brightness-110 text-white px-2 py-1 rounded font-bold transition"><i class="fas fa-plus"></i></button>`;
            const { data: polls } = await client.from('polls').select('*').order('created_at', { ascending: false }).limit(1);
            if(!polls || polls.length === 0) { container.innerHTML = '<p class="text-slate-500 text-xs">Nenhuma votação ativa.</p>'; return; }
            const poll = polls[0]; const { data: votes } = await client.from('poll_votes').select('*').eq('poll_id', poll.id);
            const myVote = votes.find(v => v.user_id === currentUser.id); const counts = new Array(poll.options.length).fill(0);
            votes.forEach(v => counts[v.option_index]++); const totalVotes = votes.length; const maxVotes = Math.max(...counts);
            let html = `<h4 class="text-sm font-bold text-white mb-3 text-center">${poll.question}</h4><div class="space-y-3">`;
            poll.options.forEach((opt, index) => {
                const count = counts[index]; const percent = totalVotes === 0 ? 0 : Math.round((count / totalVotes) * 100);
                if (myVote) {
                    const isWinner = count === maxVotes && totalVotes > 0; const isSelected = myVote.option_index === index;
                    html += `<div class="poll-bar-container"><div class="poll-bar-fill ${isWinner ? 'winner' : ''}" style="width: ${percent}%;"></div><div class="poll-bar-text"><span>${opt} ${isSelected ? '<i class="fas fa-check-circle text-white ml-1"></i>' : ''}</span><span>${percent}%</span></div></div>`;
                } else { html += `<button onclick="vote(${poll.id}, ${index})" class="w-full text-left bg-slate-800 hover:bg-white/10 p-3 rounded-lg text-xs font-bold text-slate-300 border border-slate-700 hover:border-theme-dynamic transition shadow-md">${opt}</button>`; }
            });
            html += `</div><p class="text-[10px] text-slate-500 mt-3 text-right">${totalVotes} votos totais</p>`; container.innerHTML = html;
        }
        window.createPoll = async function() { const q = prompt("Pergunta:"); if(!q) return; const o = prompt("Opções (vírgula):"); if(!o) return; try { await client.from('polls').insert({ question: q, options: o.split(',').map(s=>s.trim()).filter(s=>s) }); loadPoll(); } catch(e){ alert("Erro: "+e.message); } }
        window.vote = async function(pid, idx) { try { await client.from('poll_votes').insert({ poll_id: pid, option_index: idx, user_id: currentUser.id }); await gainXP(10); loadPoll(); } catch(e) { alert("Já votou!"); loadPoll(); } }

        async function loadNews() {
            const feed = document.getElementById('news-feed'), adminBtn = document.getElementById('admin-news-btn');
            if(currentProfile && currentProfile.is_admin) adminBtn.innerHTML = `<button onclick="postNews()" class="text-[10px] bg-theme-dynamic hover:brightness-110 text-white px-2 py-1 rounded font-bold transition"><i class="fas fa-plus"></i></button>`;
            const { data } = await client.from('news').select('*').order('created_at', { ascending: false }).limit(10); feed.innerHTML = '';
            if(!data || data.length === 0) feed.innerHTML = '<p class="text-slate-500 italic text-sm">Nenhum aviso.</p>'; 
            else data.forEach(item => { const d = new Date(item.created_at).toLocaleDateString('pt-BR'); feed.innerHTML += `<div class="glass-panel p-3 rounded-lg border-l-4 border-theme-dynamic"><div class="flex justify-between items-start"><h4 class="font-bold text-white text-sm">${item.title}</h4><span class="text-[10px] text-slate-400 bg-black/50 px-2 rounded">${d}</span></div><p class="text-xs text-slate-300 mt-1">${item.content || ''}</p></div>`; });
        }
        window.postNews = async function() { const t = prompt("Título:"); if(!t) return; const c = prompt("Msg:"); try { await client.from('news').insert({ title: t, content: c }); loadNews(); } catch(e) { alert("Erro: "+e.message); } }

        async function loadRanking() {
            const list = document.getElementById('ranking-list'); const { data } = await client.from('profiles').select('*').order('xp', { ascending: false }).limit(20); list.innerHTML = ''; let p = 1;
            if(data) data.forEach((u) => { if (u.email.includes('guilhermefontelas09')) return; if (p > 10) return; let c = p === 1 ? 'text-yellow-400' : (p === 2 ? 'text-gray-300' : (p === 3 ? 'text-amber-600' : 'text-slate-400')); list.innerHTML += `<div class="flex items-center gap-3 border-b border-white/5 pb-2"><span class="font-bold ${c} text-sm w-4">#${p}</span><div class="w-6 h-6 rounded-full bg-slate-800 flex items-center justify-center text-[10px] font-bold text-white border border-white/10">${u.avatar_text}</div><span class="text-xs text-white flex-1 truncate">${u.nickname || u.email.split('@')[0]}</span><span class="text-xs font-bold text-theme-dynamic">${u.xp} XP</span></div>`; p++; });
        }

        async function loadGallery() {
            const grid = document.getElementById('gallery-grid'); const { data } = await client.from('gallery').select('*').order('created_at', { ascending: false }); let h = '';
            if (currentProfile && currentProfile.is_admin) h += `<label class="btn-upload glass-panel rounded-xl" for="file-upload" id="upload-label"><i class="fas fa-plus text-3xl mb-2 text-theme-dynamic"></i><span class="text-xs font-bold uppercase">Adicionar</span><input type="file" id="file-upload" accept="image/*" class="hidden"></label>`;
            if(data && data.length > 0) data.forEach(img => { h += `<div class="glass-panel rounded-xl overflow-hidden cursor-pointer group pop-in border border-transparent hover:border-theme-dynamic" onclick="window.open('${img.image_url}', '_blank')"><div class="h-40 bg-cover bg-center group-hover:scale-110 transition-transform duration-500" style="background-image: url('${img.image_url}')"></div></div>`; }); else if (!currentProfile || !currentProfile.is_admin) h += `<div class="col-span-2 text-slate-500 text-sm">Vazio.</div>`;
            grid.innerHTML = h; const fi = document.getElementById('file-upload'); if (fi) fi.addEventListener('change', handleUpload);
        }
        async function handleUpload(e) { const f = e.target.files[0]; if (!f) return; const s = document.getElementById('upload-status'), l = document.getElementById('upload-label'); s.textContent = "Enviando..."; s.classList.remove('hidden'); l.classList.add('uploading'); try { const fn = `foto_${Date.now()}_${sanitizeFileName(f.name)}`; const { error } = await client.storage.from('images').upload(fn, f); if (error) throw error; const { data: { publicUrl } } = client.storage.from('images').getPublicUrl(fn); await client.from('gallery').insert({ title: 'Nova Foto', image_url: publicUrl }); await gainXP(20); await loadGallery(); setTimeout(() => { s.classList.add('hidden'); }, 2000); } catch (er) { alert("Erro: " + er.message); s.classList.add('hidden'); loadGallery(); } }

        async function loadDownloads() {
            const c = document.getElementById('downloads-container'); const { data } = await client.from('downloads').select('*').order('created_at', { ascending: false }); let uh = '';
            if (currentProfile && currentProfile.is_admin) uh = `<label class="btn-upload glass-panel rounded-lg mb-4" for="material-upload" id="material-label" style="min-height: 60px; border-style: dashed;"><i class="fas fa-plus text-xl mb-1 text-theme-dynamic"></i><span class="text-[10px] font-bold uppercase">Novo Material</span><input type="file" id="material-upload" class="hidden"></label>`;
            let ih = (!data || data.length === 0) ? '<p class="text-slate-500 text-xs">Sem arquivos.</p>' : '';
            if(data) data.forEach(i => { ih += `<div class="list-item p-2 rounded flex items-center gap-3 cursor-pointer border-b border-white/5" onclick="window.open('${i.link}', '_blank')"><div class="w-8 h-8 rounded bg-white/5 flex items-center justify-center text-theme-dynamic flex-shrink-0 border border-white/10"><i class="fas fa-file-pdf"></i></div><div class="overflow-hidden"><p class="font-bold text-xs truncate text-white">${i.title}</p><p class="text-[10px] text-slate-400">${i.category || 'Arquivo'}</p></div></div>`; });
            c.innerHTML = uh + '<div id="actual-list">' + ih + '</div>'; const mi = document.getElementById('material-upload'); if (mi) mi.addEventListener('change', handleMaterialUpload);
        }
        async function handleMaterialUpload(e) { const f = e.target.files[0]; if (!f) return; const t = prompt("Nome:", f.name); if (!t) return; const s = document.getElementById('upload-material-status'), l = document.getElementById('material-label'); s.textContent = "Enviando..."; s.classList.remove('hidden'); if(l) l.classList.add('uploading'); try { const fn = `doc_${Date.now()}_${sanitizeFileName(f.name)}`; const { error } = await client.storage.from('materials').upload(fn, f); if (error) throw error; const { data: { publicUrl } } = client.storage.from('materials').getPublicUrl(fn); await client.from('downloads').insert({ title: t, category: 'Material', link: publicUrl }); await loadDownloads(); setTimeout(() => { s.classList.add('hidden'); }, 2000); } catch (er) { alert("Erro: " + er.message); s.classList.add('hidden'); loadDownloads(); } }

        async function renderMiniCalendar() {
            const date = new Date(), year = date.getFullYear(), month = date.getMonth(), months = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];
            document.getElementById('mini-month').textContent = `${months[month]}`.toUpperCase();
            const s = new Date(year, month, 1).toISOString(), e = new Date(year, month + 1, 0).toISOString();
            let evs = []; try { const { data } = await client.from('calendar').select('*').gte('event_date', s).lte('event_date', e); if(data) evs = data; } catch(err){}
            const g = document.getElementById('mini-calendar-grid'); g.innerHTML = '<div class="text-[10px] text-slate-500">D</div><div class="text-[10px] text-slate-500">S</div><div class="text-[10px] text-slate-500">T</div><div class="text-[10px] text-slate-500">Q</div><div class="text-[10px] text-slate-500">Q</div><div class="text-[10px] text-slate-500">S</div><div class="text-[10px] text-slate-500">S</div>';
            const fd = new Date(year, month, 1).getDay(), dim = new Date(year, month + 1, 0).getDate(), t = new Date().getDate();
            for(let i=0; i<fd; i++) g.innerHTML += `<div></div>`;
            for(let d=1; d<=dim; d++) {
                const ds = `${year}-${String(month+1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const ev = evs.find(x => x.event_date === ds), it = (d === t); let cl = '';
                if(ev) { cl = 'has-event'; if(ev.type) { const tp = ev.type.toLowerCase(); if(tp.includes('prova')) cl += ' evt-prova'; else if(tp.includes('trabalho')) cl += ' evt-trabalho'; else if(tp.includes('simulado')) cl += ' evt-simulado'; } }
                g.innerHTML += `<div class="calendar-day ${it ? 'current-day' : ''} ${cl}">${d}</div>`;
            }
        }
        
        const chatBox = document.getElementById('chat-box');
        async function setupChat() { const { data: msgs } = await client.from('messages').select('*').order('created_at', { ascending: true }).limit(50); if(msgs) msgs.forEach(addMsg); client.channel('public:messages').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, p => addMsg(p.new)).subscribe(); }
        function addMsg(msg) { const isMe = msg.user_id === currentUser.id, senderName = isMe ? 'Eu' : msg.email.split('@')[0]; chatBox.innerHTML += `<div class="flex flex-col ${isMe?'items-end':'items-start'} mb-2"><div class="${isMe?'bg-theme-dynamic':'bg-slate-700'} px-4 py-2 rounded-xl max-w-[80%] text-sm shadow text-white"><span class="text-[10px] opacity-50 block mb-1 font-bold">${senderName}</span>${msg.content}</div></div>`; chatBox.scrollTop = chatBox.scrollHeight; }
        document.getElementById('chat-form').onsubmit = async (e) => { e.preventDefault(); const i = document.getElementById('chat-msg'); if(!i.value.trim())return; await client.from('messages').insert({content:i.value, user_id:currentUser.id, email:currentUser.email}); await gainXP(5); i.value=''; };

        window.goToSection = function(target) {
            document.querySelectorAll('.page-section').forEach(s => s.classList.add('hidden')); document.getElementById(`section-${target}`).classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(b => { b.classList.replace('text-theme-dynamic', 'text-slate-500'); if(b.dataset.target === target) b.classList.replace('text-slate-500', 'text-theme-dynamic'); });
        }
        document.querySelectorAll('.nav-btn').forEach(btn => btn.onclick = () => goToSection(btn.dataset.target));
        const doLogout = async () => { await client.auth.signOut(); location.reload(); };
        document.getElementById('btn-logout-sidebar').onclick = doLogout; document.getElementById('mobile-logout-top').onclick = doLogout;
        client.auth.getSession().then(({ data: { session } }) => { if (session) { currentUser = session.user; enterApp(); } });
    </script>
</body>
</html>
